<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilienempfehlung erstellen - RedBird Beraterportal</title>
    <link rel="stylesheet" href="../css/ui-enhanced.css">
    <link rel="stylesheet" href="../css/typography-enhanced.css">
    <link rel="stylesheet" href="../css/admin-styles.css">
    <link rel="stylesheet" href="../css/forms-enhanced.css">
    <link rel="stylesheet" href="../css/notifications-enhanced.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .recommendation-form {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 20px;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .preview-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .preview-frame {
            width: 100%;
            height: 600px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .client-needs-section,
        .property-details-section {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--surface-light-color);
            border-radius: 4px;
        }
        
        .steps-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .step {
            flex: 1;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        
        .step.active {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 2px;
            background-color: var(--border-color);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .match-percentage {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
        }
        
        .match-percentage-value {
            font-size: 2.5rem;
        }
        
        .match-categories {
            margin: 20px 0;
        }
        
        .match-category {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .category-name {
            flex: 0 0 120px;
            font-weight: bold;
        }
        
        .category-bar {
            flex: 1;
            height: 20px;
            background-color: var(--neutral-300);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .category-fill {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.5s ease;
        }
        
        .category-status {
            flex: 0 0 80px;
            text-align: right;
        }
        
        .status-match {
            color: var(--success-color);
        }
        
        .status-partial {
            color: var(--warning-color);
        }
        
        .status-no-match {
            color: var(--error-color);
        }
        
        .analysis-results {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-col {
            flex: 1;
            min-width: 250px;
        }
        
        .benefits-list, 
        .considerations-list {
            padding-left: 20px;
        }
        
        .benefits-list li {
            color: var(--success-color);
            margin-bottom: 5px;
        }
        
        .benefits-list li span {
            color: var(--text-color);
        }
        
        .considerations-list li {
            color: var(--warning-color);
            margin-bottom: 5px;
        }
        
        .considerations-list li span {
            color: var(--text-color);
        }
        
        .client-needs-table,
        .property-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .client-needs-table th,
        .client-needs-table td,
        .property-details-table th,
        .property-details-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .client-needs-table th,
        .property-details-table th {
            font-weight: bold;
            background-color: var(--neutral-200);
        }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- Include Admin Header -->
    <div id="admin-header-placeholder"></div>
    
    <!-- Main Content -->
    <div class="admin-content">
        <!-- Include Admin Sidebar -->
        <div id="admin-sidebar-placeholder"></div>
        
        <!-- Content Area -->
        <main class="admin-main">
            <div class="admin-header">
                <h1><i class="fas fa-file-pdf"></i> Immobilienempfehlung erstellen</h1>
                <div class="admin-header-actions">
                    <div class="admin-search">
                        <input type="text" placeholder="Suchen..." aria-label="Suchen">
                        <button aria-label="Suchen"><i class="fas fa-search"></i></button>
                    </div>
                    <button class="btn btn-primary" id="helpBtn">
                        <i class="fas fa-question-circle"></i>
                        <span>Hilfe</span>
                    </button>
                </div>
            </div>
            
            <div class="admin-content-wrapper">
                <div class="steps-container">
                    <div class="step active" data-step="1">1. Kunde & Immobilie auswählen</div>
                    <div class="step" data-step="2">2. Analyse & Anpassungen</div>
                    <div class="step" data-step="3">3. Vorschau & Finalisierung</div>
                </div>
                
                <!-- Step 1: Select Client and Property -->
                <div class="step-content" id="step1">
                    <div class="card">
                        <div class="card-header">
                            <h2>Kunde und Immobilie auswählen</h2>
                        </div>
                        <div class="card-body">
                            <div class="recommendation-form">
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="clientSelect">Kunde auswählen</label>
                                        <select id="clientSelect" class="form-control">
                                            <option value="">-- Kunde auswählen --</option>
                                            <option value="client-123">Max Mustermann</option>
                                            <option value="client-124">Erika Musterfrau</option>
                                            <option value="client-125">Karl Schmidt</option>
                                        </select>
                                    </div>
                                    <div class="form-col">
                                        <label for="propertySelect">Immobilie auswählen</label>
                                        <select id="propertySelect" class="form-control">
                                            <option value="">-- Immobilie auswählen --</option>
                                            <option value="property-789">Sunset Bay Resort, Apartment A-203</option>
                                            <option value="property-790">Royal Gardens, Villa B-105</option>
                                            <option value="property-791">Mountain View Residences, Apartment C-310</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="client-needs-section" style="display: none;" id="clientNeedsSection">
                                    <h3>Kundenbedürfnisse</h3>
                                    <table class="client-needs-table">
                                        <tr>
                                            <th>Parameter</th>
                                            <th>Wert</th>
                                        </tr>
                                        <tr>
                                            <td>Immobilientyp</td>
                                            <td id="clientNeedsType">Apartment</td>
                                        </tr>
                                        <tr>
                                            <td>Zweck</td>
                                            <td id="clientNeedsPurpose">Investment und Eigennutzung</td>
                                        </tr>
                                        <tr>
                                            <td>Größe</td>
                                            <td id="clientNeedsSize">75 - 100 m²</td>
                                        </tr>
                                        <tr>
                                            <td>Budget</td>
                                            <td id="clientNeedsBudget">120.000 € - 170.000 €</td>
                                        </tr>
                                        <tr>
                                            <td>Zimmer</td>
                                            <td id="clientNeedsRooms">2 - 3</td>
                                        </tr>
                                        <tr>
                                            <td>Muss-Kriterien</td>
                                            <td id="clientNeedsMustHave">Meerblick, Pool, Klimaanlage</td>
                                        </tr>
                                        <tr>
                                            <td>Wünschenswert</td>
                                            <td id="clientNeedsNiceToHave">Tiefgarage, Tennisplatz, Spa-Bereich</td>
                                        </tr>
                                        <tr>
                                            <td>Standortpräferenzen</td>
                                            <td id="clientNeedsLocation">Strandnähe, Ruhige Lage, Einkaufsmöglichkeiten in der Nähe</td>
                                        </tr>
                                        <tr>
                                            <td>Angestrebte Rendite</td>
                                            <td id="clientNeedsRoi">5%</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="property-details-section" style="display: none;" id="propertyDetailsSection">
                                    <h3>Immobiliendetails</h3>
                                    <table class="property-details-table">
                                        <tr>
                                            <th>Parameter</th>
                                            <th>Wert</th>
                                        </tr>
                                        <tr>
                                            <td>Name</td>
                                            <td id="propertyName">Sunset Bay Resort, Apartment A-203</td>
                                        </tr>
                                        <tr>
                                            <td>Typ</td>
                                            <td id="propertyType">2+1 Apartment</td>
                                        </tr>
                                        <tr>
                                            <td>Lage</td>
                                            <td id="propertyLocation">Esentepe, Nordzypern</td>
                                        </tr>
                                        <tr>
                                            <td>Preis</td>
                                            <td id="propertyPrice">150.000 €</td>
                                        </tr>
                                        <tr>
                                            <td>Größe</td>
                                            <td id="propertySize">85 m²</td>
                                        </tr>
                                        <tr>
                                            <td>Zimmer</td>
                                            <td id="propertyRooms">2</td>
                                        </tr>
                                        <tr>
                                            <td>Ausstattung</td>
                                            <td id="propertyFeatures">Meerblick, Gemeinschaftspool, Tiefgarage, Klimaanlage, Fußbodenheizung, Vollmöbliert, Garten</td>
                                        </tr>
                                        <tr>
                                            <td>Rendite (ROI)</td>
                                            <td id="propertyRoi">6,33%</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="actions-bar">
                                    <div></div> <!-- Empty div for flex alignment -->
                                    <button class="btn btn-primary" id="nextToStep2" disabled>Weiter zur Analyse <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Analysis and Adjustments -->
                <div class="step-content" id="step2" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Analyse & Anpassungen</h2>
                        </div>
                        <div class="card-body">
                            <div class="recommendation-form">
                                <div class="match-percentage">
                                    <div>Übereinstimmung</div>
                                    <div class="match-percentage-value" id="overallMatchPercentage">85%</div>
                                </div>
                                
                                <div class="match-categories">
                                    <div class="match-category">
                                        <div class="category-name">Immobilientyp</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <div class="category-status status-match" id="propertyTypeMatch">✓</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Größe</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <div class="category-status status-match" id="sizeMatch">✓</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Preis</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <div class="category-status status-match" id="priceMatch">✓</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Zimmer</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <div class="category-status status-match" id="roomsMatch">✓</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Ausstattung</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 90%;"></div>
                                        </div>
                                        <div class="category-status status-partial" id="featuresMatch">90%</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Standort</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 75%;"></div>
                                        </div>
                                        <div class="category-status status-partial" id="locationMatch">75%</div>
                                    </div>
                                    
                                    <div class="match-category">
                                        <div class="category-name">Investment</div>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <div class="category-status status-match" id="investmentMatch">✓</div>
                                    </div>
                                </div>
                                
                                <div class="analysis-results">
                                    <div class="analysis-col">
                                        <h3><i class="fas fa-check-circle" style="color: var(--success-color);"></i> Wichtigste Vorteile</h3>
                                        <ul class="benefits-list" id="benefitsList">
                                            <li><span>Innerhalb des Budgets (150.000 €)</span></li>
                                            <li><span>Enthält alle gewünschten Eigenschaften: Meerblick, Pool, Klimaanlage</span></li>
                                            <li><span>Übertrifft die angestrebte Rendite mit 6,33%</span></li>
                                            <li><span>Erfüllt 2 Standortpräferenzen: Strandnähe, Einkaufsmöglichkeiten in der Nähe</span></li>
                                            <li><span>Umfangreiche Ausstattung mit 7 Merkmalen</span></li>
                                        </ul>
                                    </div>
                                    <div class="analysis-col">
                                        <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> Zu berücksichtigende Aspekte</h3>
                                        <ul class="considerations-list" id="considerationsList">
                                            <li><span>Große Entfernung zum Flughafen (45 km)</span></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="margin-top: 20px;">
                                    <div class="form-col">
                                        <label for="additionalNotes">Zusätzliche Notizen zum Dokument</label>
                                        <textarea id="additionalNotes" class="form-control" rows="4" placeholder="Fügen Sie hier zusätzliche Informationen oder Hinweise hinzu, die im generierten Dokument erscheinen sollen..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="actions-bar">
                                    <button class="btn btn-outline" id="backToStep1"><i class="fas fa-arrow-left"></i> Zurück zur Auswahl</button>
                                    <button class="btn btn-primary" id="nextToStep3">Weiter zur Vorschau <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Preview and Generate -->
                <div class="step-content" id="step3" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2>Vorschau & Finalisierung</h2>
                        </div>
                        <div class="card-body">
                            <div class="preview-container">
                                <h3>PDF Vorschau</h3>
                                <div id="pdfPreview" class="preview-frame">
                                    <iframe id="pdfIframe" style="width:100%; height:100%; border:none;"></iframe>
                                </div>
                                
                                <div class="form-row" style="margin-top: 20px;">
                                    <div class="form-col">
                                        <label for="documentTitle">Dokumenttitel</label>
                                        <input type="text" id="documentTitle" class="form-control" value="Immobilienempfehlung - Sunset Bay Resort, Apartment A-203" placeholder="Titel des Dokuments">
                                    </div>
                                    <div class="form-col">
                                        <label for="documentCategory">Kategorie</label>
                                        <select id="documentCategory" class="form-control">
                                            <option value="recommendation">Empfehlung</option>
                                            <option value="analysis">Analyse</option>
                                            <option value="proposal">Angebot</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="checkbox-container">
                                            <input type="checkbox" id="notifyClient" checked>
                                            <label for="notifyClient">Kunden per E-Mail benachrichtigen</label>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="checkbox-container">
                                            <input type="checkbox" id="includeComparison">
                                            <label for="includeComparison">Vergleich mit ähnlichen Immobilien einfügen</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="actions-bar">
                                    <button class="btn btn-outline" id="backToStep2"><i class="fas fa-arrow-left"></i> Zurück zur Analyse</button>
                                    <div>
                                        <button class="btn btn-outline" id="downloadPdf">
                                            <i class="fas fa-download"></i> PDF herunterladen
                                        </button>
                                        <button class="btn btn-primary" id="generateAndSave">
                                            <i class="fas fa-save"></i> Generieren & speichern
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Hilfe zur Immobilienempfehlung</h3>
                <button class="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <h4>Wie erstellt man eine Immobilienempfehlung</h4>
                <p>Eine Immobilienempfehlung ist ein Dokument, das die Bedürfnisse eines Kunden mit einer spezifischen Immobilie abgleicht und eine fachliche Einschätzung bietet, ob diese Immobilie für den Kunden geeignet ist.</p>
                
                <h4>Schritte zur Erstellung:</h4>
                <ol>
                    <li><strong>Kunde & Immobilie auswählen</strong>: Wählen Sie den Kunden und die zu empfehlende Immobilie aus.</li>
                    <li><strong>Analyse & Anpassungen</strong>: Überprüfen Sie die automatisch generierte Analyse und passen Sie sie bei Bedarf an.</li>
                    <li><strong>Vorschau & Finalisierung</strong>: Sehen Sie sich das fertige Dokument an und speichern Sie es im Kundenbereich.</li>
                </ol>
                
                <h4>Tipps für effektive Empfehlungen:</h4>
                <ul>
                    <li>Stellen Sie sicher, dass die Kundenbedürfnisse aktuell sind.</li>
                    <li>Fügen Sie persönliche Notizen hinzu, um die Empfehlung zu personalisieren.</li>
                    <li>Betonen Sie die Vorteile, ohne Nachteile zu verschweigen.</li>
                    <li>Schlagen Sie konkrete nächste Schritte vor.</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Notification container -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Scripts -->
    <script src="../js/notifications-enhanced.js"></script>
    <script src="../js/admin-layout.js"></script>
    <script src="../js/theme-enhanced.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Initialize notification system explicitly for this page
        document.addEventListener('DOMContentLoaded', function() {
            if (window.RedBirdNotify) {
                window.RedBirdNotify.configure({
                    position: 'top-right',
                    duration: 5000,
                    maxNotifications: 5
                });
            }
        });
    </script>
    
    <script type="module">
        import PropertyRecommendationGenerator from '../js/property-recommendation-generator.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load admin templates
            document.getElementById('admin-header-placeholder').innerHTML = 
                '<div id="admin-header"></div>';
            document.getElementById('admin-sidebar-placeholder').innerHTML = 
                '<div id="admin-sidebar"></div>';
            
            loadAdminLayout();
            
            // Step navigation
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            
            // Help modal
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeModal = helpModal.querySelector('.close-modal');
            
            helpBtn.addEventListener('click', function() {
                helpModal.style.display = 'flex';
            });
            
            closeModal.addEventListener('click', function() {
                helpModal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === helpModal) {
                    helpModal.style.display = 'none';
                }
            });
            
            // Form handling
            const clientSelect = document.getElementById('clientSelect');
            const propertySelect = document.getElementById('propertySelect');
            const nextToStep2Btn = document.getElementById('nextToStep2');
            const backToStep1Btn = document.getElementById('backToStep1');
            const nextToStep3Btn = document.getElementById('nextToStep3');
            const backToStep2Btn = document.getElementById('backToStep2');
            const downloadPdfBtn = document.getElementById('downloadPdf');
            const generateAndSaveBtn = document.getElementById('generateAndSave');
            
            const clientNeedsSection = document.getElementById('clientNeedsSection');
            const propertyDetailsSection = document.getElementById('propertyDetailsSection');
            
            let recommendationGenerator = null;
            let pdfOutput = null;
            
            // Enable/disable next button based on selections
            function checkSelections() {
                if (clientSelect.value && propertySelect.value) {
                    nextToStep2Btn.disabled = false;
                    
                    // Show client needs and property details sections
                    clientNeedsSection.style.display = 'block';
                    propertyDetailsSection.style.display = 'block';
                } else {
                    nextToStep2Btn.disabled = true;
                    
                    // Hide client needs and property details sections
                    clientNeedsSection.style.display = 'none';
                    propertyDetailsSection.style.display = 'none';
                }
            }
            
            clientSelect.addEventListener('change', checkSelections);
            propertySelect.addEventListener('change', checkSelections);
            
            // Show/hide loading overlay functions
            function showLoading() {
                document.getElementById('loadingOverlay').classList.add('visible');
            }
            
            function hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('visible');
            }
            
            // Step 1 to Step 2
            nextToStep2Btn.addEventListener('click', async function() {
                try {
                    // Show loading overlay
                    showLoading();
                    
                    // Create recommendation generator
                    recommendationGenerator = new PropertyRecommendationGenerator();
                    
                    // Initialize with selected client and property
                    const success = await recommendationGenerator.initialize(
                        clientSelect.value,
                        propertySelect.value
                    );
                    
                    if (success) {
                        // Update analysis data
                        updateAnalysisData(recommendationGenerator.matchAnalysis);
                        
                        // Navigate to step 2
                        showStep(2);
                    } else {
                        throw new Error('Failed to initialize recommendation generator');
                    }
                } catch (error) {
                    console.error('Error initializing recommendation:', error);
                    
                    if (window.RedBirdNotify) {
                        window.RedBirdNotify.error(
                            'Fehler beim Erstellen der Empfehlung. Bitte versuchen Sie es erneut.',
                            'Fehler'
                        );
                    }
                } finally {
                    // Hide loading overlay
                    hideLoading();
                }
            });
            
            // Step 2 to Step 1
            backToStep1Btn.addEventListener('click', function() {
                showStep(1);
            });
            
            // Step 2 to Step 3
            nextToStep3Btn.addEventListener('click', async function() {
                try {
                    // Show loading overlay
                    showLoading();
                    
                    // Generate PDF
                    pdfOutput = await recommendationGenerator.generatePDF();
                    
                    // Set PDF in iframe
                    const pdfIframe = document.getElementById('pdfIframe');
                    pdfIframe.src = pdfOutput;
                    
                    // Navigate to step 3
                    showStep(3);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    
                    if (window.RedBirdNotify) {
                        window.RedBirdNotify.error(
                            'Fehler beim Generieren der PDF. Bitte versuchen Sie es erneut.',
                            'Fehler'
                        );
                    }
                } finally {
                    // Hide loading overlay
                    hideLoading();
                }
            });
            
            // Step 3 to Step 2
            backToStep2Btn.addEventListener('click', function() {
                showStep(2);
            });
            
            // Download PDF
            downloadPdfBtn.addEventListener('click', function() {
                if (pdfOutput) {
                    // Create a link to download the PDF
                    const link = document.createElement('a');
                    link.href = pdfOutput;
                    link.download = document.getElementById('documentTitle').value + '.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    if (window.RedBirdNotify) {
                        window.RedBirdNotify.error(
                            'PDF konnte nicht generiert werden. Bitte versuchen Sie es erneut.',
                            'Fehler'
                        );
                    }
                }
            });
            
            // Generate and save PDF
            generateAndSaveBtn.addEventListener('click', async function() {
                try {
                    // Show loading overlay
                    showLoading();
                    
                    if (recommendationGenerator && pdfOutput) {
                        const documentTitle = document.getElementById('documentTitle').value;
                        const notifyClient = document.getElementById('notifyClient').checked;
                        
                        // Save to client's documents
                        const savedDoc = await recommendationGenerator.saveToDocs(documentTitle + '.pdf');
                        
                        if (savedDoc) {
                            if (window.RedBirdNotify) {
                                window.RedBirdNotify.success(
                                    'Die Immobilienempfehlung wurde erfolgreich im Kundenbereich gespeichert.' +
                                    (notifyClient ? ' Der Kunde wurde per E-Mail benachrichtigt.' : ''),
                                    'Erfolgreich gespeichert'
                                );
                            }
                            
                            // Reset form and return to step 1
                            resetForm();
                            showStep(1);
                        } else {
                            throw new Error('Failed to save document');
                        }
                    } else {
                        throw new Error('No PDF generated');
                    }
                } catch (error) {
                    console.error('Error saving document:', error);
                    
                    if (window.RedBirdNotify) {
                        window.RedBirdNotify.error(
                            'Fehler beim Speichern der Empfehlung. Bitte versuchen Sie es erneut.',
                            'Fehler'
                        );
                    }
                } finally {
                    // Hide loading overlay
                    hideLoading();
                }
            });
            
            // Function to update analysis data in the UI
            function updateAnalysisData(matchAnalysis) {
                if (!matchAnalysis) return;
                
                // Set overall match percentage
                document.getElementById('overallMatchPercentage').textContent = 
                    `${matchAnalysis.overall_match_percentage}%`;
                
                // Update category matches
                document.getElementById('propertyTypeMatch').textContent = 
                    matchAnalysis.categories.property_type.match ? '✓' : '✗';
                document.getElementById('propertyTypeMatch').className = 
                    matchAnalysis.categories.property_type.match ? 'category-status status-match' : 'category-status status-no-match';
                
                document.getElementById('sizeMatch').textContent = 
                    matchAnalysis.categories.size.match ? '✓' : '✗';
                document.getElementById('sizeMatch').className = 
                    matchAnalysis.categories.size.match ? 'category-status status-match' : 'category-status status-no-match';
                
                document.getElementById('priceMatch').textContent = 
                    matchAnalysis.categories.price.match ? '✓' : '✗';
                document.getElementById('priceMatch').className = 
                    matchAnalysis.categories.price.match ? 'category-status status-match' : 'category-status status-no-match';
                
                document.getElementById('roomsMatch').textContent = 
                    matchAnalysis.categories.rooms.match ? '✓' : '✗';
                document.getElementById('roomsMatch').className = 
                    matchAnalysis.categories.rooms.match ? 'category-status status-match' : 'category-status status-no-match';
                
                const featuresPercentage = Math.round(matchAnalysis.categories.features.match_percentage);
                document.getElementById('featuresMatch').textContent = `${featuresPercentage}%`;
                document.getElementById('featuresMatch').className = 
                    featuresPercentage >= 80 ? 'category-status status-match' : 
                    featuresPercentage >= 50 ? 'category-status status-partial' : 
                    'category-status status-no-match';
                
                const locationPercentage = Math.round(matchAnalysis.categories.location.match_percentage);
                document.getElementById('locationMatch').textContent = `${locationPercentage}%`;
                document.getElementById('locationMatch').className = 
                    locationPercentage >= 80 ? 'category-status status-match' : 
                    locationPercentage >= 50 ? 'category-status status-partial' : 
                    'category-status status-no-match';
                
                document.getElementById('investmentMatch').textContent = 
                    matchAnalysis.categories.investment.roi_match ? '✓' : '✗';
                document.getElementById('investmentMatch').className = 
                    matchAnalysis.categories.investment.roi_match ? 'category-status status-match' : 'category-status status-no-match';
                
                // Update category progress bars
                document.querySelectorAll('.match-category').forEach(category => {
                    const bar = category.querySelector('.category-fill');
                    const status = category.querySelector('.category-status');
                    
                    if (status.textContent === '✓') {
                        bar.style.width = '100%';
                        bar.style.backgroundColor = 'var(--success-color)';
                    } else if (status.textContent === '✗') {
                        bar.style.width = '0%';
                    } else {
                        // It's a percentage
                        const percentage = parseInt(status.textContent);
                        bar.style.width = `${percentage}%`;
                        
                        if (percentage >= 80) {
                            bar.style.backgroundColor = 'var(--success-color)';
                        } else if (percentage >= 50) {
                            bar.style.backgroundColor = 'var(--warning-color)';
                        } else {
                            bar.style.backgroundColor = 'var(--error-color)';
                        }
                    }
                });
                
                // Update benefits list
                const benefitsList = document.getElementById('benefitsList');
                benefitsList.innerHTML = '';
                
                matchAnalysis.key_benefits.forEach(benefit => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${benefit}</span>`;
                    benefitsList.appendChild(li);
                });
                
                // Update considerations list
                const considerationsList = document.getElementById('considerationsList');
                considerationsList.innerHTML = '';
                
                if (matchAnalysis.key_considerations.length > 0) {
                    matchAnalysis.key_considerations.forEach(consideration => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${consideration}</span>`;
                        considerationsList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>Keine wesentlichen Bedenken identifiziert.</span>`;
                    considerationsList.appendChild(li);
                }
            }
            
            // Function to show a specific step
            function showStep(stepNumber) {
                steps.forEach(step => {
                    if (parseInt(step.dataset.step) === stepNumber) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
                
                stepContents.forEach(content => {
                    if (content.id === `step${stepNumber}`) {
                        content.style.display = 'block';
                    } else {
                        content.style.display = 'none';
                    }
                });
            }
            
            // Function to reset form
            function resetForm() {
                clientSelect.value = '';
                propertySelect.value = '';
                document.getElementById('additionalNotes').value = '';
                document.getElementById('documentTitle').value = 'Immobilienempfehlung';
                document.getElementById('documentCategory').value = 'recommendation';
                document.getElementById('notifyClient').checked = true;
                document.getElementById('includeComparison').checked = false;
                
                recommendationGenerator = null;
                pdfOutput = null;
                
                checkSelections();
            }
            
            // Initialize
            checkSelections();
        });
    </script>
</body>
</html>