<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kundenverwaltung - RedBird Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin-refined.css">
</head>
<body class="admin-body">
  <!-- Admin Header -->
  <header class="admin-nav">
    <div class="admin-nav-container">
      <button class="admin-menu-toggle d-none">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="logo-container">
        <img src="../img/redbird-logo.svg" alt="RedBird Logo" class="nav-logo">
        <span class="admin-badge">ADMIN</span>
      </div>
      
      <ul class="admin-nav-menu">
        <li class="admin-nav-item">
          <a href="dashboard-refined.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        </li>
        <li class="admin-nav-item active">
          <a href="user-management-refined.html"><i class="fas fa-users"></i> Kunden</a>
        </li>
        <li class="admin-nav-item">
          <a href="properties.html"><i class="fas fa-building"></i> Immobilien</a>
        </li>
        <li class="admin-nav-item">
          <a href="crm-pipeline.html"><i class="fas fa-project-diagram"></i> CRM Pipeline</a>
        </li>
        <li class="admin-nav-item">
          <a href="unit-onboarding.html"><i class="fas fa-clipboard-check"></i> Unit Onboarding</a>
        </li>
        <li class="admin-nav-item">
          <a href="documents.html"><i class="fas fa-file-alt"></i> Dokumente</a>
        </li>
        <li class="admin-nav-item">
          <a href="media.html"><i class="fas fa-images"></i> Medien</a>
        </li>
      </ul>
      
      <div class="admin-user-menu">
        <button class="admin-theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
        <div class="admin-user-info">
          <div class="admin-user-name">Admin User</div>
          <div class="admin-user-role">Administrator</div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-content">
            <a href="profile.html"><i class="fas fa-user-circle"></i> Profil</a>
            <a href="settings.html"><i class="fas fa-cog"></i> Einstellungen</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Abmelden</a>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <div class="admin-layout">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-section">
        <h3>Hauptmen端</h3>
        <ul class="sidebar-menu">
          <li><a href="dashboard-refined.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="user-management-refined.html" class="active"><i class="fas fa-users"></i> Kundenverwaltung</a></li>
          <li><a href="properties.html"><i class="fas fa-building"></i> Immobilien</a></li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3>CRM & Fulfillment</h3>
        <ul class="sidebar-menu">
          <li><a href="crm-pipeline.html"><i class="fas fa-project-diagram"></i> CRM Pipeline</a></li>
          <li><a href="unit-onboarding.html"><i class="fas fa-clipboard-check"></i> Unit Onboarding</a></li>
          <li><a href="customer-data.html"><i class="fas fa-database"></i> Kundendaten</a></li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3>Inhalte</h3>
        <ul class="sidebar-menu">
          <li><a href="documents.html"><i class="fas fa-file-alt"></i> Dokumente</a></li>
          <li><a href="media.html"><i class="fas fa-images"></i> Medienverwaltung</a></li>
          <li><a href="progress.html"><i class="fas fa-tasks"></i> Fortschrittsvorlagen</a></li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3>Kommunikation</h3>
        <ul class="sidebar-menu">
          <li><a href="messaging.html"><i class="fas fa-comments"></i> Nachrichten</a></li>
          <li><a href="notifications.html"><i class="fas fa-bell"></i> Benachrichtigungen</a></li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3>System</h3>
        <ul class="sidebar-menu">
          <li><a href="settings.html"><i class="fas fa-cog"></i> Einstellungen</a></li>
          <li><a href="logs.html"><i class="fas fa-history"></i> Systemlogs</a></li>
        </ul>
      </div>
    </aside>
    
    <!-- Sidebar Overlay for mobile -->
    <div class="admin-sidebar-overlay"></div>
    
    <div class="admin-content-wrapper">
      <div class="admin-main-content">
        <div class="page-header">
          <div class="header-content">
            <h1>Kundenverwaltung</h1>
            <p>Verwalten Sie alle Benutzerkonten, Rollen und Berechtigungen</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" id="addUserBtn">
              <i class="fas fa-plus"></i> Neuen Benutzer hinzuf端gen
            </button>
          </div>
        </div>
        
        <!-- Filter Section -->
        <div class="card shadow mb-4">
          <div class="card-header">
            <h2 class="card-title">Filter</h2>
            <button class="btn btn-sm btn-outline" id="clearFiltersBtn">
              <i class="fas fa-sync-alt"></i> Zur端cksetzen
            </button>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-4 gap-4">
              <div class="form-group mb-0">
                <label for="searchTerm">Suche</label>
                <div class="d-flex">
                  <div class="position-relative w-100">
                    <input type="text" id="searchTerm" class="form-control" placeholder="Name, E-Mail oder ID">
                    <i class="fas fa-search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--neutral-400);"></i>
                  </div>
                </div>
              </div>
              
              <div class="form-group mb-0">
                <label for="roleFilter">Rolle</label>
                <select id="roleFilter" class="form-select">
                  <option value="">Alle Rollen</option>
                  <option value="admin">Admin</option>
                  <option value="advisor">Berater</option>
                  <option value="client">Kunde</option>
                </select>
              </div>
              
              <div class="form-group mb-0">
                <label for="statusFilter">Status</label>
                <select id="statusFilter" class="form-select">
                  <option value="">Alle Status</option>
                  <option value="active">Aktiv</option>
                  <option value="inactive">Inaktiv</option>
                </select>
              </div>
              
              <div class="form-group mb-0 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="applyFiltersBtn">
                  <i class="fas fa-search"></i> Anwenden
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- User List Section -->
        <div class="card shadow">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <h2 class="card-title mb-0">Benutzerliste</h2>
              <span class="badge badge-neutral ms-2" id="userDisplayCount">10</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="me-3 text-muted" style="font-size: 0.9rem">Gesamt: <span id="userTotalCount">48</span> Benutzer</span>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline dropbtn">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-content">
                  <a href="#"><i class="fas fa-download"></i> Exportieren</a>
                  <a href="#"><i class="fas fa-print"></i> Drucken</a>
                  <a href="#"><i class="fas fa-sync-alt"></i> Aktualisieren</a>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Rolle</th>
                    <th>Registrierungsdatum</th>
                    <th>Status</th>
                    <th>Immobilien</th>
                    <th class="text-end">Aktionen</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <!-- User rows will be generated by JavaScript -->
                </tbody>
              </table>
            </div>
            
            <div class="card-footer">
              <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted" style="font-size: 0.9rem">
                  Seite <span id="currentPage">1</span> von <span id="totalPages">5</span>
                </div>
                <div id="userPagination" class="d-flex gap-2">
                  <!-- Pagination will be generated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">Neuen Benutzer hinzuf端gen</h3>
          <button class="modal-close" id="modalClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="form-group mb-0">
                <label for="firstName">Vorname</label>
                <input type="text" id="firstName" name="firstName" class="form-control" required>
              </div>
              <div class="form-group mb-0">
                <label for="lastName">Nachname</label>
                <input type="text" id="lastName" name="lastName" class="form-control" required>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="form-group mb-0">
                <label for="email">E-Mail</label>
                <input type="email" id="email" name="email" class="form-control" required>
              </div>
              <div class="form-group mb-0">
                <label for="phone">Telefon</label>
                <input type="tel" id="phone" name="phone" class="form-control">
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="form-group mb-0">
                <label for="role">Rolle</label>
                <select id="role" name="role" class="form-select" required>
                  <option value="">Rolle ausw辰hlen</option>
                  <option value="admin">Admin</option>
                  <option value="advisor">Berater</option>
                  <option value="client">Kunde</option>
                </select>
              </div>
              <div class="form-group mb-0">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-select" required>
                  <option value="active">Aktiv</option>
                  <option value="inactive">Inaktiv</option>
                </select>
              </div>
            </div>
            
            <div id="propertiesSection" class="mt-4 mb-4 d-none">
              <h4 class="mb-3">Zugewiesene Immobilien</h4>
              <div class="grid grid-cols-2 gap-4 mb-3">
                <div class="form-group mb-0">
                  <label for="assignedProperty">Immobilie</label>
                  <select id="assignedProperty" name="assignedProperty" class="form-select">
                    <option value="">Immobilie ausw辰hlen</option>
                    <option value="1">Sunset Bay Resort - A-203</option>
                    <option value="2">Mountain View Apartments - B-101</option>
                    <option value="3">Riverside Villas - V-22</option>
                  </select>
                </div>
                <div class="form-group mb-0 d-flex align-items-end">
                  <button type="button" class="btn btn-outline" id="addPropertyBtn">
                    <i class="fas fa-plus"></i> Hinzuf端gen
                  </button>
                </div>
              </div>
              
              <div id="assignedPropertiesList" class="mt-3">
                <!-- Assigned properties will be listed here -->
              </div>
            </div>
            
            <div id="advisorSection" class="mb-4 d-none">
              <h4 class="mb-3">Berater-Zuweisung</h4>
              <div class="form-group mb-0">
                <label for="assignedAdvisor">Zugewiesener Berater</label>
                <select id="assignedAdvisor" name="assignedAdvisor" class="form-select">
                  <option value="">Berater ausw辰hlen</option>
                  <option value="1">John Berater</option>
                  <option value="2">Emma Beraterin</option>
                  <option value="3">Michael Experte</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="form-group mb-0">
                <label for="password">Passwort</label>
                <input type="password" id="password" name="password" class="form-control">
                <div class="form-text">
                  Leer lassen f端r zuf辰lliges Passwort (neuer Benutzer) oder aktuelles Passwort (Bearbeiten)
                </div>
              </div>
              <div class="form-group mb-0">
                <label for="confirmPassword">Passwort best辰tigen</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control">
              </div>
            </div>
            
            <div class="form-check">
              <input type="checkbox" id="sendWelcomeEmail" name="sendWelcomeEmail" checked class="form-check-input">
              <label for="sendWelcomeEmail" class="form-check-label">
                Willkommens-E-Mail mit Anmeldedaten senden
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" id="cancelUserBtn">Abbrechen</button>
          <button class="btn btn-primary" id="saveUserBtn">Benutzer speichern</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      const htmlElement = document.documentElement;
      
      // Check for saved theme or use default
      const savedTheme = localStorage.getItem('rb_admin_theme') || 'light';
      htmlElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      themeToggle.addEventListener('click', function() {
        const currentTheme = htmlElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        htmlElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('rb_admin_theme', newTheme);
        updateThemeIcon(newTheme);
        
        showNotification(`${newTheme === 'dark' ? 'Dunkles' : 'Helles'} Design aktiviert`, 'info');
      });
      
      // Mobile menu toggle
      const menuToggle = document.querySelector('.admin-menu-toggle');
      const sidebar = document.querySelector('.admin-sidebar');
      const overlay = document.querySelector('.admin-sidebar-overlay');
      
      // Show menu toggle on small screens
      if (window.innerWidth <= 768) {
        menuToggle.classList.remove('d-none');
      }
      
      window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
          menuToggle.classList.remove('d-none');
        } else {
          menuToggle.classList.add('d-none');
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
        }
      });
      
      menuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      });
      
      overlay.addEventListener('click', function() {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      });
      
      // Demo data for users
      const demoUsers = [
        {
          id: '001',
          firstName: 'Admin',
          lastName: 'User',
          email: 'admin@redbird.com',
          phone: '+49 123 456789',
          role: 'admin',
          status: 'active',
          registrationDate: '2024-12-01',
          properties: []
        },
        {
          id: '002',
          firstName: 'John',
          lastName: 'Advisor',
          email: 'advisor@redbird.com',
          phone: '+49 234 567890',
          role: 'advisor',
          status: 'active',
          registrationDate: '2025-01-15',
          properties: []
        },
        {
          id: '003',
          firstName: 'Demo',
          lastName: 'Client',
          email: 'client@example.com',
          phone: '+49 345 678901',
          role: 'client',
          status: 'active',
          registrationDate: '2025-02-10',
          properties: [
            { id: '1', name: 'Sunset Bay Resort', unit: 'A-203' }
          ],
          advisor: { id: '002', name: 'John Advisor' }
        },
        {
          id: '004',
          firstName: 'Emma',
          lastName: 'Consultant',
          email: 'emma@redbird.com',
          phone: '+49 456 789012',
          role: 'advisor',
          status: 'active',
          registrationDate: '2025-01-20',
          properties: []
        },
        {
          id: '005',
          firstName: 'Michael',
          lastName: 'Expert',
          email: 'michael@redbird.com',
          phone: '+49 567 890123',
          role: 'advisor',
          status: 'inactive',
          registrationDate: '2025-02-05',
          properties: []
        },
        {
          id: '006',
          firstName: 'Sarah',
          lastName: 'Johnson',
          email: 'sarah@example.com',
          phone: '+49 678 901234',
          role: 'client',
          status: 'active',
          registrationDate: '2025-03-10',
          properties: [
            { id: '2', name: 'Mountain View Apartments', unit: 'B-101' }
          ],
          advisor: { id: '004', name: 'Emma Consultant' }
        },
        {
          id: '007',
          firstName: 'Robert',
          lastName: 'Smith',
          email: 'robert@example.com',
          phone: '+49 789 012345',
          role: 'client',
          status: 'active',
          registrationDate: '2025-03-15',
          properties: [
            { id: '3', name: 'Riverside Villas', unit: 'V-22' }
          ],
          advisor: { id: '002', name: 'John Advisor' }
        },
        {
          id: '008',
          firstName: 'Thomas',
          lastName: 'Admin',
          email: 'thomas@redbird.com',
          phone: '+49 890 123456',
          role: 'admin',
          status: 'active',
          registrationDate: '2025-01-05',
          properties: []
        },
        {
          id: '009',
          firstName: 'David',
          lastName: 'Brown',
          email: 'david@example.com',
          phone: '+49 901 234567',
          role: 'client',
          status: 'inactive',
          registrationDate: '2025-02-20',
          properties: [],
          advisor: { id: '004', name: 'Emma Consultant' }
        },
        {
          id: '010',
          firstName: 'Lisa',
          lastName: 'Miller',
          email: 'lisa@example.com',
          phone: '+49 012 345678',
          role: 'client',
          status: 'active',
          registrationDate: '2025-03-25',
          properties: [
            { id: '1', name: 'Sunset Bay Resort', unit: 'B-105' }
          ],
          advisor: { id: '002', name: 'John Advisor' }
        }
      ];
      
      // Store users in localStorage if not already there
      if (!localStorage.getItem('rb_demo_users')) {
        localStorage.setItem('rb_demo_users', JSON.stringify(demoUsers));
      }
      
      // Get elements
      const userTableBody = document.getElementById('userTableBody');
      const userDisplayCount = document.getElementById('userDisplayCount');
      const userTotalCount = document.getElementById('userTotalCount');
      const userPagination = document.getElementById('userPagination');
      const currentPageElement = document.getElementById('currentPage');
      const totalPagesElement = document.getElementById('totalPages');
      
      // Modal elements
      const userModal = document.getElementById('userModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalClose = document.getElementById('modalClose');
      const addUserBtn = document.getElementById('addUserBtn');
      const cancelUserBtn = document.getElementById('cancelUserBtn');
      const saveUserBtn = document.getElementById('saveUserBtn');
      const userForm = document.getElementById('userForm');
      const roleSelect = document.getElementById('role');
      const propertiesSection = document.getElementById('propertiesSection');
      const advisorSection = document.getElementById('advisorSection');
      
      // Filter elements
      const searchTerm = document.getElementById('searchTerm');
      const roleFilter = document.getElementById('roleFilter');
      const statusFilter = document.getElementById('statusFilter');
      const applyFiltersBtn = document.getElementById('applyFiltersBtn');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      
      // Current page and filters
      let currentPage = 1;
      const pageSize = 10;
      let currentFilters = {
        search: '',
        role: '',
        status: ''
      };
      
      // Initialize the user list
      initUserList();
      
      // Event Listeners
      roleSelect.addEventListener('change', toggleUserSections);
      addUserBtn.addEventListener('click', openAddUserModal);
      modalClose.addEventListener('click', closeUserModal);
      cancelUserBtn.addEventListener('click', closeUserModal);
      saveUserBtn.addEventListener('click', saveUser);
      applyFiltersBtn.addEventListener('click', applyFilters);
      clearFiltersBtn.addEventListener('click', clearFilters);
      
      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Simulate logout
        showNotification('Sie wurden erfolgreich abgemeldet', 'success');
        
        // In a real app, we would also clear auth tokens and redirect
        setTimeout(() => {
          window.location.href = '../login.html';
        }, 1000);
      });
      
      // Function to initialize user list
      function initUserList() {
        // Load users from localStorage
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        
        // Update total count
        userTotalCount.textContent = users.length;
        
        // Apply initial filters and render
        filterAndRenderUsers();
      }
      
      // Function to filter and render users
      function filterAndRenderUsers() {
        // Get users from localStorage
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        
        // Apply filters
        let filteredUsers = users.filter(user => {
          // Search filter
          if (currentFilters.search) {
            const searchLower = currentFilters.search.toLowerCase();
            const fullName = (user.firstName + ' ' + user.lastName).toLowerCase();
            const email = user.email.toLowerCase();
            
            if (!fullName.includes(searchLower) && !email.includes(searchLower) && !user.id.includes(searchLower)) {
              return false;
            }
          }
          
          // Role filter
          if (currentFilters.role && user.role !== currentFilters.role) {
            return false;
          }
          
          // Status filter
          if (currentFilters.status && user.status !== currentFilters.status) {
            return false;
          }
          
          return true;
        });
        
        // Update count
        userDisplayCount.textContent = filteredUsers.length;
        
        // Calculate total pages
        const totalPages = Math.ceil(filteredUsers.length / pageSize);
        totalPagesElement.textContent = totalPages;
        currentPageElement.textContent = currentPage;
        
        // Paginate
        const startIndex = (currentPage - 1) * pageSize;
        const paginatedUsers = filteredUsers.slice(startIndex, startIndex + pageSize);
        
        // Clear table
        userTableBody.innerHTML = '';
        
        // Render users
        paginatedUsers.forEach(user => {
          const row = document.createElement('tr');
          
          // User name column
          const nameCell = document.createElement('td');
          nameCell.innerHTML = `
            <div class="d-flex align-items-center">
              <div class="avatar avatar-sm bg-${getBgColorClass(user.role)}-light text-${getBgColorClass(user.role)} me-3">${user.firstName.charAt(0)}${user.lastName.charAt(0)}</div>
              <div>
                <div class="font-weight-bold">${user.firstName} ${user.lastName}</div>
                <div class="text-muted" style="font-size: 0.8rem">${user.email}</div>
              </div>
            </div>
          `;
          
          // Role column
          const roleCell = document.createElement('td');
          let roleClass = getRoleBadgeClass(user.role);
          
          roleCell.innerHTML = `
            <span class="badge ${roleClass}">${capitalizeFirstLetter(user.role)}</span>
          `;
          
          // Registration date column
          const dateCell = document.createElement('td');
          const date = new Date(user.registrationDate);
          const formattedDate = new Intl.DateTimeFormat('de-DE').format(date);
          dateCell.textContent = formattedDate;
          
          // Status column
          const statusCell = document.createElement('td');
          const statusClass = user.status === 'active' ? 'badge-success' : 'badge-neutral';
          statusCell.innerHTML = `
            <span class="badge ${statusClass}">${user.status === 'active' ? 'Aktiv' : 'Inaktiv'}</span>
          `;
          
          // Properties column
          const propertiesCell = document.createElement('td');
          const propertiesCount = user.properties ? user.properties.length : 0;
          if (propertiesCount > 0) {
            propertiesCell.innerHTML = `<span class="badge badge-info">${propertiesCount}</span>`;
          } else {
            propertiesCell.innerHTML = `<span class="text-muted">-</span>`;
          }
          
          // Actions column
          const actionsCell = document.createElement('td');
          actionsCell.className = 'text-end';
          actionsCell.innerHTML = `
            <div class="d-flex gap-1 justify-content-end">
              <button class="btn btn-sm btn-outline edit-user" data-id="${user.id}" title="Bearbeiten">
                <i class="fas fa-edit"></i>
              </button>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline dropbtn">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-content">
                  <a href="#" class="view-user" data-id="${user.id}"><i class="fas fa-eye"></i> Anzeigen</a>
                  <a href="#" class="send-email" data-id="${user.id}"><i class="fas fa-envelope"></i> E-Mail senden</a>
                  <a href="#" class="reset-pwd" data-id="${user.id}"><i class="fas fa-key"></i> Passwort zur端cksetzen</a>
                  <a href="#" class="delete-user" data-id="${user.id}"><i class="fas fa-trash"></i> L旦schen</a>
                </div>
              </div>
            </div>
          `;
          
          // Add event listeners to action buttons
          row.appendChild(nameCell);
          row.appendChild(roleCell);
          row.appendChild(dateCell);
          row.appendChild(statusCell);
          row.appendChild(propertiesCell);
          row.appendChild(actionsCell);
          
          // Append row to table
          userTableBody.appendChild(row);
        });
        
        // After rendering, add event listeners
        document.querySelectorAll('.edit-user').forEach(btn => {
          btn.addEventListener('click', () => {
            openEditUserModal(btn.dataset.id);
          });
        });
        
        document.querySelectorAll('.view-user').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            viewUser(link.dataset.id);
          });
        });
        
        document.querySelectorAll('.send-email').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const userId = link.dataset.id;
            const user = users.find(u => u.id === userId);
            showNotification(`E-Mail an ${user.firstName} ${user.lastName} wird gesendet...`, 'info');
          });
        });
        
        document.querySelectorAll('.reset-pwd').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const userId = link.dataset.id;
            const user = users.find(u => u.id === userId);
            showNotification(`Passwort f端r ${user.firstName} ${user.lastName} wurde zur端ckgesetzt`, 'success');
          });
        });
        
        document.querySelectorAll('.delete-user').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            deleteUser(link.dataset.id);
          });
        });
        
        // Render pagination
        renderPagination(filteredUsers.length);
      }
      
      // Function to render pagination
      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / pageSize);
        
        // Clear pagination
        userPagination.innerHTML = '';
        
        // Add previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-sm btn-outline';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.disabled = currentPage === 1;
        prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            currentPageElement.textContent = currentPage;
            filterAndRenderUsers();
          }
        });
        userPagination.appendChild(prevBtn);
        
        // Add page buttons - show a maximum of 5 page buttons
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4 && totalPages > 5) {
          startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = 'btn btn-sm';
          if (i === currentPage) {
            pageBtn.classList.add('btn-primary');
          } else {
            pageBtn.classList.add('btn-outline');
          }
          pageBtn.textContent = i;
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            currentPageElement.textContent = currentPage;
            filterAndRenderUsers();
          });
          userPagination.appendChild(pageBtn);
        }
        
        // Add next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-sm btn-outline';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            currentPage++;
            currentPageElement.textContent = currentPage;
            filterAndRenderUsers();
          }
        });
        userPagination.appendChild(nextBtn);
      }
      
      // Function to toggle user sections based on role
      function toggleUserSections() {
        const selectedRole = roleSelect.value;
        
        if (selectedRole === 'client') {
          propertiesSection.classList.remove('d-none');
          advisorSection.classList.remove('d-none');
        } else {
          propertiesSection.classList.add('d-none');
          advisorSection.classList.add('d-none');
        }
      }
      
      // Function to open add user modal
      function openAddUserModal() {
        // Reset form
        userForm.reset();
        
        // Update modal title
        modalTitle.textContent = 'Neuen Benutzer hinzuf端gen';
        
        // Hide property and advisor sections
        propertiesSection.classList.add('d-none');
        advisorSection.classList.add('d-none');
        
        // Store user ID in form (hidden field would be better in a real app)
        userForm.dataset.userId = '';
        
        // Show modal
        userModal.classList.add('active');
      }
      
      // Function to open edit user modal
      function openEditUserModal(userId) {
        // Load user data
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        const user = users.find(u => u.id === userId);
        
        if (!user) {
          showNotification('Benutzer nicht gefunden', 'error');
          return;
        }
        
        // Reset form
        userForm.reset();
        
        // Update modal title
        modalTitle.textContent = 'Benutzer bearbeiten';
        
        // Fill form with user data
        document.getElementById('firstName').value = user.firstName;
        document.getElementById('lastName').value = user.lastName;
        document.getElementById('email').value = user.email;
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('role').value = user.role;
        document.getElementById('status').value = user.status;
        
        // Toggle sections based on role
        if (user.role === 'client') {
          propertiesSection.classList.remove('d-none');
          advisorSection.classList.remove('d-none');
          
          // If user has an advisor, select it
          if (user.advisor) {
            document.getElementById('assignedAdvisor').value = user.advisor.id;
          }
          
          // Display assigned properties
          const assignedPropertiesList = document.getElementById('assignedPropertiesList');
          assignedPropertiesList.innerHTML = '';
          
          if (user.properties && user.properties.length > 0) {
            user.properties.forEach(property => {
              const propertyItem = document.createElement('div');
              propertyItem.className = 'd-flex align-items-center bg-light p-2 rounded mb-2';
              
              propertyItem.innerHTML = `
                <div class="flex-grow-1">
                  <strong>${property.name}</strong> - ${property.unit}
                </div>
                <button type="button" class="btn btn-sm btn-outline remove-property" data-id="${property.id}">
                  <i class="fas fa-times"></i>
                </button>
              `;
              
              assignedPropertiesList.appendChild(propertyItem);
            });
          }
        } else {
          propertiesSection.classList.add('d-none');
          advisorSection.classList.add('d-none');
        }
        
        // Store user ID in form (hidden field would be better in a real app)
        userForm.dataset.userId = userId;
        
        // Show modal
        userModal.classList.add('active');
      }
      
      // Function to view user details
      function viewUser(userId) {
        // In a real app, this would open a read-only view
        // For demo purposes, we'll just open the edit modal
        openEditUserModal(userId);
      }
      
      // Function to delete user
      function deleteUser(userId) {
        // Get user for notification
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        const user = users.find(u => u.id === userId);
        
        if (confirm(`Sind Sie sicher, dass Sie "${user.firstName} ${user.lastName}" l旦schen m旦chten?`)) {
          // Filter out the user
          const updatedUsers = users.filter(user => user.id !== userId);
          
          // Save updated users
          localStorage.setItem('rb_demo_users', JSON.stringify(updatedUsers));
          
          // Refresh the list
          filterAndRenderUsers();
          
          // Show success message
          showNotification('Benutzer erfolgreich gel旦scht', 'success');
        }
      }
      
      // Function to close user modal
      function closeUserModal() {
        userModal.classList.remove('active');
      }
      
      // Function to save user
      function saveUser() {
        // Get form data
        const formData = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          role: document.getElementById('role').value,
          status: document.getElementById('status').value,
          password: document.getElementById('password').value,
          confirmPassword: document.getElementById('confirmPassword').value,
          sendWelcomeEmail: document.getElementById('sendWelcomeEmail').checked
        };
        
        // Validate form
        if (!formData.firstName || !formData.lastName || !formData.email || !formData.role || !formData.status) {
          showNotification('Bitte f端llen Sie alle erforderlichen Felder aus', 'error');
          return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          showNotification('Bitte geben Sie eine g端ltige E-Mail-Adresse ein', 'error');
          return;
        }
        
        // Validate password match if provided
        if (formData.password && formData.password !== formData.confirmPassword) {
          showNotification('Passw旦rter stimmen nicht 端berein', 'error');
          return;
        }
        
        // Load users
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        
        // Check if editing or adding
        const userId = userForm.dataset.userId;
        
        if (userId) {
          // Editing existing user
          const userIndex = users.findIndex(user => user.id === userId);
          
          if (userIndex === -1) {
            showNotification('Benutzer nicht gefunden', 'error');
            return;
          }
          
          // Update user data
          users[userIndex] = {
            ...users[userIndex],
            firstName: formData.firstName,
            lastName: formData.lastName,
            email: formData.email,
            phone: formData.phone,
            role: formData.role,
            status: formData.status
          };
          
          // If role is client, handle advisor assignment
          if (formData.role === 'client') {
            const advisorId = document.getElementById('assignedAdvisor').value;
            if (advisorId) {
              const advisor = users.find(u => u.id === advisorId);
              users[userIndex].advisor = {
                id: advisor.id,
                name: `${advisor.firstName} ${advisor.lastName}`
              };
            } else {
              users[userIndex].advisor = null;
            }
          }
          
          // Save updated users
          localStorage.setItem('rb_demo_users', JSON.stringify(users));
          
          // Show success message
          showNotification('Benutzer erfolgreich aktualisiert', 'success');
        } else {
          // Adding new user
          const newUser = {
            id: generateUserId(),
            firstName: formData.firstName,
            lastName: formData.lastName,
            email: formData.email,
            phone: formData.phone,
            role: formData.role,
            status: formData.status,
            registrationDate: new Date().toISOString().split('T')[0],
            properties: []
          };
          
          // If role is client, handle advisor assignment
          if (formData.role === 'client') {
            const advisorId = document.getElementById('assignedAdvisor').value;
            if (advisorId) {
              const advisor = users.find(u => u.id === advisorId);
              newUser.advisor = {
                id: advisor.id,
                name: `${advisor.firstName} ${advisor.lastName}`
              };
            }
          }
          
          // Add user to array
          users.push(newUser);
          
          // Save updated users
          localStorage.setItem('rb_demo_users', JSON.stringify(users));
          
          // Show success message with welcome email notification if checked
          if (formData.sendWelcomeEmail) {
            showNotification(`Benutzer erfolgreich hinzugef端gt. Willkommens-E-Mail wurde an ${formData.email} gesendet.`, 'success');
          } else {
            showNotification('Benutzer erfolgreich hinzugef端gt', 'success');
          }
        }
        
        // Close modal
        closeUserModal();
        
        // Refresh the list
        filterAndRenderUsers();
      }
      
      // Function to apply filters
      function applyFilters() {
        // Update current filters
        currentFilters.search = searchTerm.value.trim();
        currentFilters.role = roleFilter.value;
        currentFilters.status = statusFilter.value;
        
        // Reset to first page
        currentPage = 1;
        
        // Apply filters
        filterAndRenderUsers();
        
        // Show message
        const filterCount = [currentFilters.search, currentFilters.role, currentFilters.status].filter(Boolean).length;
        if (filterCount > 0) {
          showNotification(`Filter angewendet: ${filterCount} aktive Filter`, 'info');
        }
      }
      
      // Function to clear filters
      function clearFilters() {
        // Reset filter inputs
        searchTerm.value = '';
        roleFilter.value = '';
        statusFilter.value = '';
        
        // Reset current filters
        currentFilters.search = '';
        currentFilters.role = '';
        currentFilters.status = '';
        
        // Reset to first page
        currentPage = 1;
        
        // Apply filters
        filterAndRenderUsers();
        
        // Show message
        showNotification('Filter zur端ckgesetzt', 'info');
      }
      
      // Function to generate a unique user ID
      function generateUserId() {
        const users = JSON.parse(localStorage.getItem('rb_demo_users'));
        const lastId = Math.max(...users.map(user => parseInt(user.id, 10)));
        return (lastId + 1).toString().padStart(3, '0');
      }
      
      // Helper functions
      function updateThemeIcon(theme) {
        const icon = themeToggle.querySelector('i');
        if (theme === 'dark') {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }
      }
      
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      
      function getRoleBadgeClass(role) {
        switch (role) {
          case 'admin':
            return 'badge-danger';
          case 'advisor':
            return 'badge-info';
          case 'client':
            return 'badge-success';
          default:
            return 'badge-neutral';
        }
      }
      
      function getBgColorClass(role) {
        switch (role) {
          case 'admin':
            return 'danger';
          case 'advisor':
            return 'info';
          case 'client':
            return 'success';
          default:
            return 'primary';
        }
      }
      
      function showNotification(message, type = 'info', duration = 4000) {
        const container = document.getElementById('notificationContainer');
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        // Choose icon based on type
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        if (type === 'error') iconClass = 'fas fa-exclamation-circle';
        if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
        
        notification.innerHTML = `
          <div class="notification-icon">
            <i class="${iconClass}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // Add to container
        container.appendChild(notification);
        
        // Close button functionality
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', function() {
          notification.classList.add('closing');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        });
        
        // Auto remove after duration
        setTimeout(() => {
          if (notification.parentNode) {
            notification.classList.add('closing');
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }
        }, duration);
      }
    });
  </script>
</body>
</html>